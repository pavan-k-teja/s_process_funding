<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.min.js"></script>

<!-- Load the sankey.js function -->
<script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/sankey.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>


<style>
    .link,
    .link-inactive {
        fill: none;
        stroke: #000;
        stroke-opacity: .2;
    }

    .link-inactive {
        stroke-dasharray: 5 10;
    }

    .link:hover {
        stroke-opacity: .5;
    }
</style>

<!-- <script id="test" type="application/json" src="./input.json"></script> -->

<script>

    // get graph data from input.json file
    // var graph = JSON.parse("input.json");
    var graph;

    fetch('input.json')
        .then(response => response.json())
        .then(data => {
            graph = data;
            console.log(graph);
        })
        .then(() => {


            // set the dimensions and margins of the graph
            var margin = { top: 10, right: 10, bottom: 10, left: 10 },
                width = 2050 - margin.left - margin.right,
                height = 2080 - margin.top - margin.bottom;

            // append the svg object to the body of the page
            var svg = d3.select("#my_dataviz")
                .append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom)
                .append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Color scale used
            var color = d3.scaleOrdinal(d3.schemeCategory20);

            // Set the sankey diagram properties
            var sankey = d3.sankey()
                .nodeWidth(36)
                .nodePadding(290)
                .size([width, height]);

            // var graph = {
            //     "nodes": [
            //         { "node": 0, "name": "node0", "id": "test0" },
            //         { "node": 1, "name": "node1", "id": "test1" },
            //         { "node": 2, "name": "node2", "id": "test2" },
            //         { "node": 3, "name": "node3", "id": "test3" },
            //         { "node": 4, "name": "node4", "id": "test4" }
            //     ],
            //     "links": [
            //         { "source": 0, "target": 2, "value": 2, "active": false },
            //         { "source": 1, "target": 2, "value": 20, "active": true },
            //         { "source": 1, "target": 3, "value": 2, "active": true },
            //         { "source": 0, "target": 4, "value": 2, "active": true },
            //         { "source": 2, "target": 3, "value": 2, "active": true },
            //         { "source": 2, "target": 4, "value": 2, "active": false },
            //         { "source": 3, "target": 4, "value": 4, "active": false }
            //     ]
            // };

            // Constructs a new Sankey generator with the default settings.
            sankey.nodes(graph.nodes).links(graph.links).layout(1);

            // add in the links
            var link = svg.append("g")
                .selectAll(".link")
                .data(graph.links)
                .enter().append("path")
                .attr("class", function (d) { return d.active ? "link" : "link-inactive"; })
                .attr("d", sankey.link())
                .style("stroke-width", function (d) { return Math.max(1, d.dy); })
                .sort(function (a, b) { return b.dy - a.dy; });

            // add in the nodes
            var node = svg.append("g")
                .selectAll(".node")
                .data(graph.nodes)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; })
                .on('click', click);

            // add the rectangles for the nodes
            node.append("rect")
                .attr("height", function (d) { return d.dy; })
                .attr("width", sankey.nodeWidth())
                .style("fill", function (d) { return d.color = color(d.name.replace(/ .*/, "")); })
                .style("stroke", function (d) { return d3.rgb(d.color).darker(2); })
                .append("title").text(function (d) { return d.name + "\n(" + d.id + ")"; });

            // add in the title for the nodes
            node.append("text")
                .attr("x", -6)
                .attr("y", function (d) { return d.dy / 2; })
                .attr("dy", ".35em")
                .attr("text-anchor", "end")
                .attr("transform", null)
                .text(function (d) { return d.name; })
                .filter(function (d) { return d.x < width / 2; })
                .attr("x", 6 + sankey.nodeWidth())
                .attr("text-anchor", "start");

            function click(d) {
                if (d3.event.defaultPrevented) return; // click suppressed
                console.log(d.id);
            }

        });

</script>